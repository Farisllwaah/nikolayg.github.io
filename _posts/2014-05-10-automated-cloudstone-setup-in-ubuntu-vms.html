---
layout: post
title: Automated CloudStone Setup in Ubuntu VMs
date: 2014-05-10 02:32:26.000000000 +10:00
type: post
published: true
status: publish
categories:
- CloudStone
tags:
- Bash
- CloudStone
- Ubuntu
meta:
  _wpas_done_all: '1'
  _wpcom_is_markdown: '1'
  _publicize_pending: '1'
  publicize_google_plus_url: https://plus.google.com/116873873608085229608/posts/jhrcDEwnNpB
  publicize_linkedin_url: http://www.linkedin.com/updates?discuss=&scope=30071619&stype=M&topic=5870555711620001792&type=U&a=dab1
  _wpas_done_5385652: '1'
  _publicize_done_external: a:1:{s:11:"google_plus";a:1:{s:21:"116873873608085229608";b:1;}}
  publicize_twitter_user: nikolaygrozev
  publicize_twitter_url: http://t.co/OBwmVaua3l
  _wpas_done_5385644: '1'
  _wpas_done_5385639: '1'
  _wpas_skip_5385652: '1'
  _wpas_skip_5385644: '1'
  _wpas_skip_5385639: '1'
  geo_public: '0'
  _edit_last: '1'
  _kad_blog_head: default
  _kad_post_summery: default
  _kad_post_sidebar: 'yes'
  _kad_sidebar_choice: sidebar-primary
  _kad_blog_author: default
  _kad_blog_carousel_similar: default
  _thumbnail_id: '174'
author:
  login: nikolaygrozev
  email: nikolay.grozev@gmail.com
  display_name: nikolaygrozev
  first_name: ''
  last_name: ''
---
<h1>Introduction</h1>
<p>One of the major obstacles in Cloud computing research is the lack of representative "cloudy" applications and workloads. This makes it hard for researchers to test their new approaches in areas like load balancing, resource provisioning and autoscaling with realistic industry-inspired environments. The <a href="http://parsa.epfl.ch/cloudsuite/cloudsuite.html" title="CloudStone 2.0">CloudSuite 2.0</a> suite of benchmarking applications tries to address just that. It comprises 8 benchmarks, which represent a large spectrum of typical applications run in cloud environments. Among them is CloudStone, which is a social media 3-tier web application benchmark. It is very useful in the research of web applications hosted in clouds, as it is the only (to the best of my knowledge) modern Web 2.0 benchmarking application.</p>
<p>However, as with other academic benchmarking tools, the installation is not straightforward. Some insidious bugs and middleware incompatibilities need to be patched, making it quite difficult to set up and use. This article introduces several scripts that automate CloudStone's installation on 64bit Ubuntu 14.04 virtual machines. These scripts have been tested in Amazon AWS, but in principle they should work in other Infrastructure as a Service (IaaS) environments as well.</p>
<h1>CloudStone Overview</h1>
<p>In its simplest form CloudStone is composed of three Virtual Machines (VMs) running the <em><u>Olio</u></em> application - a client/driver, a web/application server (AS) and a database server (DB). The client machine executes the workload, consisting of multiple users' actions, against the AS server. The web server VM runs the application itself in an <em>Nginx</em> server. It also hosts a <em>filestore</em> with users' multimedia content (e.g. images). The DB server provides access to a <em>MySql</em> database with the application data. It also hosts a <em>GeoCoder</em> service hosted in an <em>Apache Tomcat</em> instance providing geocoding services (e.g. mapping latitude/longitude to zip codes) to the application server.</p>
<p>The load generation and the performance monitoring are enabled by the <a href="https://github.com/akara/faban">Faban</a> benchmarking harness. The so called <em>Faban master</em> (or <em>driver)</em> process runs on the client VM, and emulates the user workload to the servers. The Faban driver starts <em>Faban agent</em> processes on the AS and DB servers, through which it monitors their performance throughout the benchmark execution.</p>
<p>The following diagram depicts the target setup of CloudStone:</p>
<p>[caption id="attachment_168" align="aligncenter" width="625"]<img src="{{ site.baseurl }}/assets/cloudstoneoverview.png" alt="CloudSton Architecture" width="625" class="size-full wp-image-168" /> CloudStone Architecture[/caption]</p>
<h1>Prerequisites</h1>
<p><u><span style="color:#993300;text-decoration:underline;"><strong>Security Notice!</strong></span></u> CloudStone implicitly requires that all VM machines can <em>ping</em> each other and connect to each other at random ports. Thus you should create a separate firewall setting (i.e. a Security Group), which allows this and which is <u>used only for running CloudStone</u>. The following screenshot shows the security group used in this tutorial, which allows pinging and access to all TCP ports from anywhere. Alternatively, you can create a security group allowing such access only from the CloudStone VMs' addresses. Furthermore, CloudStone assumes that all machines can ssh into each other without any prompts. Hence our scripts need to copy the key (i.e. the <u>_pem_</u> file) across all machines. Thus it is advised to <u>create a new pem file only for running CloudStone</u>.</p>
<p>[caption id="attachment_171" align="aligncenter" width="640"]<img src="{{ site.baseurl }}/assets/securitygroup-1024x538.png" alt="CloudStone security Group in AWS" width="640" class="size-large wp-image-171" /> CloudStone security Group in AWS[/caption]</p>
<p>Before starting the setup, you should create 3 VM instances running <strong><u>64 bit Ubuntu 14.04</u></strong> - the client, the web and the DB servers. They should be configured with a permissive Security Group and using the same dedicated <em>pem</em> file, as described above. The application/web server VM should have at least 50GB mounted disk storage in order to host the <em>filestore</em>.</p>
<p>You should also have a fourth Linux machine, which will guide the installation process. We will call it the "<u>_Installer_</u>" machine. This could be your PC or laptop. If you don't have a Linux machine available, you could use a dedicated VM in the cloud. It uses SSH and SCP to configure appropriately and start all servers. The next diagram depicts the setup topology.</p>
<p>[caption id="attachment_174" align="aligncenter" width="640"]<img src="{{ site.baseurl }}/assets/cloudstoneinstallationtopology.png" alt="The installer Linux machine uses SSH and SCP to configure the CloudStone VMs. All CloudStone VMs run 64bit Ubuntu 14.04, have the same pem file (e.g. CloudStone.pem) and the same permissive security group (e.g. named CloudStone" width="640" class="size-full wp-image-174" /> The installer Linux machine uses SSH and SCP to configure the CloudStone VMs. All CloudStone VMs run 64bit Ubuntu 14.04, have the same pem file (e.g. CloudStone.pem) and the same permissive security group (e.g. named CloudStone[/caption]</p>
<h1>Installation</h1>
<p>Once you have configured the CloudStone VMs you can continue with the installation. The installation scripts are hosted in a <a href="https://github.com/nikolayg/CloudStoneSetupOnUbuntu">GitHub repository called CloudStoneSetupOnUbuntu</a>. From the installer machine you can either clone the GIT repository, or download the archive and extract it. After that you need to copy the <em>pem</em> file (e.g. CloudStone.pem) for accessing the VMs into the newly created directory with the scripts.</p>
<p>As a next step you need to tell the scripts the addresses of the CloudStone VMs and the name of the key. Edit the <u>main_installer.sh</u> file and modify the properties with the VM addresses and the key name. It should look something like that:</p>
<pre><code class="bash">clientIPAddress=ec2-XX-XX-XX-XX.ap-southeast-2.compute.amazonaws.com
asIPAddress=ec2-XX-XX-XX-XX.ap-southeast-2.compute.amazonaws.com
dbIPAddress=ec2-XX-XX-XX-XX.ap-southeast-2.compute.amazonaws.com

pemFile=CloudStone.pem
</code></pre>
<p>Now we are ready to proceed with the installation. From the directory with the scripts, issue the following command:</p>
<pre><code class="bash">sudo bash main_installer.sh
</code></pre>
<p>This will start the installation process. In the beginning, you may be prompted to accept the addition of the 3 VMs to the list of known ssh hosts. The installation can take quite some time! To monitor the progress and check for errors you can look at the log, which is written to the following files in the home directory of the installer machine:</p>
<ul>
<li><u>~/client-setup.log</u> - the log for installing the Client VM. The first to be written.</li>
<li><u>~/as-setup.log</u> - the log for installing the Web/AS VM. Written after the installation of the Client VM.</li>
<li><u>~/db-setup.log</u> - the log for installing the DB VM. Written after the installation of the Web/AS VM.</li>
</ul>
<p>If the installation is successful you shouldn't see any error messages in the logs and each log file should end with an "INSTALLATION SUMMARY" section similar to the following one:</p>
<pre><code>==== ==== ==== ==== INSTALLATION SUMMARY ==== ==== ==== ====

$JAVA_HOME:     /usr/lib/jvm/java-6-openjdk-amd64
$JDK_HOME:      /usr/lib/jvm/java-6-openjdk-amd64
$OLIO_HOME:     /cloudstone/apache-olio-php-src-0.2
$FABAN_HOME:    /cloudstone/faban
$APP_DIR:       /var/www
$FILESTORE:     /mnt/filestorage
</code></pre>
<p>The summary sections of the log files list installation environment variables, showing where the different components are installed. We will need this information to run CloudStone.</p>
<h1>Running CloudStone</h1>
<p>To run CloudStone point your browser to <u>http:// [ client-vm-address ] :9980</u>, where <u>[client-vm-address]</u> is the address of the Client VM. You should see a screen like the following one:</p>
<p>[caption id="attachment_179" align="aligncenter" width="440"]<img src="{{ site.baseurl }}/assets/fabanoliomainscreen-1024x703.png" alt="Faban Main Screen" width="440" class="size-large wp-image-179" /> Faban Main Screen[/caption]</p>
<p>Click on <u>Schedule Run</u>, input a profile name (e.g. Test) and click select. In the following wizard, you need to define the details of the CloudStone setup and the executed workload. You can use the following screenshots as a guide:</p>
<p>[gallery ids="189,180,182,181"]</p>
<p>After setting up the benchmark click OK to start it. You can view the benchmark progress and eventually the result from the "View Results" menu.</p>
<p>[gallery ids="186,185"]</p>
<p>Now that you've got CloudStone up and running, you can run different workloads (i.e. number of users) by just modifying the appropriate parameters.</p>
<h1>Under The Cover</h1>
<p>We saw that the installation was done by configuring and running a single bash script. This section is more technical and describes in more details the structure of the installation scripts, so you can debug if something goes wrong.</p>
<p>The main function of the <u>main_installer.sh</u> script is to run in sequence the installations of the CloudStone VMs and to transfer the required files to and from the servers. Under the cover, <u>main_installer.sh</u> sets the parameters of, transfers and runs 3 scripts on the CloudStone VMs. These are:</p>
<ul>
<li><u>client-setup.sh</u> - executed on the client VM. Its log is redirected to <em>~/client-setup.log</em> on the installer machine.</li>
<li><u>as-setup.sh</u> - executed on the web/application server VM. Its log is redirected to <em>~/as-setup.log</em> on the installer machine.</li>
<li><u>db-setup.sh</u> - executed on the DB VM. Its log is redirected to <em>~/db-setup.log</em> on the installer machine.</li>
</ul>
<p>Two additional scripts implement the installation logic which is common for multiple CloudStone VMs:</p>
<ul>
<li><u>base-setup.sh</u> - executed by all setup scripts. Installs common packages, sets up common variables etc.</li>
<li><u>base-server.sh</u> - executed by <u>as-setup.sh</u> and <u>db-setup.sh</u>. Implements common logic for the installation of the web/application and DB server.</li>
</ul>
<p>All these scripts have been written following the <a href="http://parsa.epfl.ch/cloudsuite/web.html">official CloudStone installation instructions</a>. They also include fixes for a lot of unexpected errors and thus differ significantly from the official installation procedure.</p>
<p>The main differences are:</p>
<ul>
<li>CloudStone comes with a distribution of Faban, which according to the documentation should be deployed and used. However this version had several issues when deployed on Ubuntu. I had to fork Faban on GitHub and implement workarounds for them. The scripts use the <a href="https://github.com/nikolayg/faban">Faban fork</a> instead of the original Faban distribution. A full list of changes to Faban can be seen from forked project's history.</li>
<li>CloudStone includes a distribution of PhP code, which according to the instructions needs to be compiled and installed. However the PhP code had to be patched, as it depends on an old version of libxml2-dev and did not compile.</li>
<li>Faban assumes all VMs can ssh into each other without any prompts. The installation scripts copy the <em>pem</em> file to the CloudStone VMs and ensure their ~/.ssh/config files are set properly to allow ssh without prompts.</li>
<li>Many file permissions had to be changed and non-existing directories and files had to be created, so that the servers could have proper access to logs and system files.</li>
<li>The privileges to the <em><u>olio</u></em> MySql user had to be granted for all IP addresses, not only the web/app server address. The problem was that MySql could not perform well DNS resolution of the elastic DNS address of the web server.</li>
<li>The scripts automatically select the location for the <em><u>filestore</u></em> on the AS server. They dynamically inspect all mounted disks, and select the one with the largest amount of free storage space.</li>
</ul>
<h1>Conclusion</h1>
<p>This article introduced several Bash scripts that automate the installation of the CloudStone 2.0 benchmark. In future articles I will explore how these scripts can be ported/rewritten to Chef or Puppet configurations, and how CloudStone can be configured to use a load balancer and multiple web/app servers... so stay tuned :)</p>
<h1>References</h1>
<p>Official installation documentation:</p>
<ul>
<li><a href="http://parsa.epfl.ch/cloudsuite/web.html">http://parsa.epfl.ch/cloudsuite/web.html</a></li>
</ul>
